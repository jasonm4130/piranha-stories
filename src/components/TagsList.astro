---
import type { CollectionEntry } from 'astro:content';

interface Props {
  posts: CollectionEntry<'posts'>[];
}

const { posts } = Astro.props;

// Build tag map
const tagMap = new Map<string, typeof posts>();

posts.forEach((post) => {
  post.data.tags?.forEach((tag) => {
    if (!tagMap.has(tag)) {
      tagMap.set(tag, []);
    }
    tagMap.get(tag)!.push(post);
  });
});

// Sort tags alphabetically
const sortedTags = Array.from(tagMap.entries())
  .sort(([a], [b]) => a.toLowerCase().localeCompare(b.toLowerCase()));

function slugify(str: string): string {
  return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
}

function getSlug(id: string): string {
  return id.replace(/\.md$/, '');
}

const formatDate = (date: Date) => date.toLocaleDateString('en-US', {
  day: 'numeric',
  month: 'short',
  year: 'numeric'
});
---

<div id="tags-page">
  {sortedTags.length > 0 ? (
    <>
      <div class="tags-list">
        {sortedTags.map(([tag, tagPosts]) => (
          <a href={`#${slugify(tag)}`} class="tag-link">
            <span class="tag-name">{tag}</span>
            <span class="tag-count">{tagPosts.length}</span>
          </a>
        ))}
      </div>

      <hr />

      <div class="posts-by-tag">
        {sortedTags.map(([tag, tagPosts]) => (
          <div id={slugify(tag)} class="posts-for-tag">
            <h2>{tag}</h2>
            <ul class="posts-list">
              {tagPosts
                .filter(post => post.data.date)
                .sort((a, b) => (b.data.date?.getTime() || 0) - (a.data.date?.getTime() || 0))
                .map((post) => (
                  <li>
                    <h3>
                      <a href={`/${getSlug(post.id)}/`}>
                        {post.data.title}
                        {post.data.date && <small>{formatDate(post.data.date)}</small>}
                      </a>
                    </h3>
                  </li>
                ))}
            </ul>
          </div>
        ))}
      </div>
    </>
  ) : (
    <p><em>No tagged posts found.</em></p>
  )}
</div>
