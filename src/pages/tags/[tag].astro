---
import { getCollection } from 'astro:content';
import PageLayout from '@layouts/PageLayout.astro';

function slugify(str: string): string {
  return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
}

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    day: 'numeric',
    month: 'short',
    year: 'numeric'
  });
}

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  
  // Build a map of all unique tags
  const tagMap = new Map<string, typeof allPosts>();
  
  allPosts.forEach((post) => {
    post.data.tags?.forEach((tag) => {
      const tagSlug = slugify(tag);
      if (!tagMap.has(tagSlug)) {
        tagMap.set(tagSlug, []);
      }
      tagMap.get(tagSlug)!.push(post);
    });
  });
  
  // Generate paths for each tag
  return Array.from(tagMap.entries()).map(([tagSlug, posts]) => {
    // Find the original tag name (for display)
    const originalTag = allPosts.find(
      (post) => post.data.tags?.some((t) => slugify(t) === tagSlug)
    )?.data.tags?.find((t) => slugify(t) === tagSlug) || tagSlug;
    
    return {
      params: { tag: tagSlug },
      props: {
        tag: originalTag,
        posts: posts.sort((a, b) => 
          (b.data.date?.getTime() || 0) - (a.data.date?.getTime() || 0)
        ),
      },
    };
  });
}

interface Props {
  tag: string;
  posts: Awaited<ReturnType<typeof getCollection<'posts'>>>;
}

const { tag, posts } = Astro.props;

function getSlug(id: string): string {
  return id.replace(/\.md$/, '');
}
---

<PageLayout title={`Tag: ${tag}`}>
  <div class="posts-by-tag">
    <ul class="posts-list">
      {posts.map((post) => (
        <li>
          <h3>
            <a href={`/${getSlug(post.id)}/`}>
              {post.data.title}
              {post.data.date && <small>{formatDate(post.data.date)}</small>}
            </a>
          </h3>
          {post.data.excerpt && <p set:html={post.data.excerpt} />}
        </li>
      ))}
    </ul>
  </div>
  
  <p><a href="/tags/">‚Üê All Tags</a></p>
</PageLayout>
